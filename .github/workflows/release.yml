name: ðŸš€ Release Fabric Mod

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mod-jar

      - name: Extract version from gradle.properties
        id: version
        run: |
          VERSION=$(grep "^mod_version=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Read changelog
        id: changelog
        run: |
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: mod-jar/*.jar
          tag_name: ${{ github.ref_name }}
          name: "Authify v${{ steps.version.outputs.version }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Modrinth
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG="${{ steps.changelog.outputs.changelog }}"
          JAR_PATH=$(find mod-jar -name "*.jar" | head -n 1)

          curl -X POST https://api.modrinth.com/v2/project/gKATUjN3/version \
            -H "Authorization: $MODRINTH_TOKEN" \
            -H "Content-Type: application/json" \
            -F "data={
              \"name\": \"AuthCore v$VERSION\",
              \"version_number\": \"$VERSION\",
              \"version_type\": \"release\",
              \"game_versions\": [\"1.21.11\"],
              \"loaders\": [\"fabric\"],
              \"changelog\": \"$CHANGELOG\"
            };type=application/json" \
            -F "file=@$JAR_PATH;type=application/java-archive"
